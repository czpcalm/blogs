# React æ¨¡å¼ä¹‹çº¯ç»„ä»¶

## ä»€ä¹ˆæ˜¯çº¯ç»„ä»¶

çº¯ç»„ä»¶(Pure Component)è¿™æ¦‚å¿µè¡ç”Ÿè‡ª[çº¯å‡½æ•°](https://en.wikipedia.org/wiki/Pure_function)ã€‚çº¯å‡½æ•°æŒ‡çš„æ˜¯è¿”å›ç»“æœåªä¾èµ–äºä¼ å…¥çš„å‚æ•°ï¼Œä¸”å¯¹å‡½æ•°ä½œç”¨åŸŸå¤–æ²¡æœ‰å‰¯ä½œç”¨çš„å‡½æ•°ã€‚è¿™ç§å‡½æ•°åœ¨ç›¸åŒå‚æ•°ä¸‹ï¼Œè¿”å›ç»“æœæ˜¯ä¸å˜çš„ã€‚çº¯å‡½æ•°çš„è¿”å›å€¼èƒ½è¢«å®‰å…¨åœ°ç¼“å­˜èµ·æ¥ï¼Œåœ¨ä¸‹æ¬¡è°ƒç”¨æ—¶ï¼Œè·³è¿‡å‡½æ•°æ‰§è¡Œï¼Œç›´æ¥è¯»å–ç¼“å­˜ã€‚å› ä¸ºå‡½æ•°æ²¡æœ‰å¤–éƒ¨å‰¯ä½œç”¨ï¼Œä¸æ‰§è¡Œå‡½æ•°å¯¹æ•´ä¸ªç¨‹åºæ²¡æœ‰å½±å“ã€‚

ä¸çº¯å‡½æ•°ç±»ä¼¼ï¼Œå¦‚æœä¸€ä¸ªç»„ä»¶**åœ¨ props å’Œ state ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œæ¯æ¬¡ render çš„ç»“æœéƒ½æ˜¯ç›¸åŒçš„**ï¼Œé‚£è¿™ä¸ªç»„ä»¶å°±æ˜¯çº¯ç»„ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œçº¯ç»„ä»¶çš„ render ç»“æœåªä¾èµ–äº props å’Œ stateï¼Œå¦‚æœä¸¤æ¬¡æ¸²æŸ“ä¸­ï¼Œprops å’Œ state æ˜¯ç›¸åŒçš„ï¼Œé‚£å®ƒä»¬çš„ render ç»“æœä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚

## çº¯ç»„ä»¶è§£å†³äº†ä»€ä¹ˆé—®é¢˜

åœ¨ç†è§£çº¯ç»„ä»¶æœ‰ä»€ä¹ˆç”¨å¤„ä¹‹å‰ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹ React å¦‚ä½•æ›´æ–°ç»„ä»¶ã€‚

React åœ¨æ›´æ–°ç»„ä»¶æ—¶ï¼Œä¼šä»è§¦å‘ç»„ä»¶å¼€å§‹ï¼Œé€’å½’åœ°è°ƒç”¨æ•´é¢—å­æ ‘çš„ render å‡½æ•°ï¼Œæ„å»ºæ–°çš„è™šæ‹Ÿæ ‘ã€‚å³ä½¿å­ç»„ä»¶çš„ props å’Œ state æ²¡æœ‰å˜åŒ–ï¼Œrender å‡½æ•°è¿˜æ˜¯ä¼šè¢«æ‰§è¡Œã€‚

çœ‹è¿™ä¸ªä¾‹å­:

```jsx
const defaultMessage = "Hello!";

function Messager() {
  console.log("render in parent");
  const [messageInput, setMessageInput] = useState(defaultMessage);
  const [messageData, setMessageData] = useState({
    id: 0,
    message: "",
  });
  return (
    <div className="logger">
      <input
        value={messageInput}
        onChange={(e) => setMessageInput(e.target.value)}
      ></input>
      <button
        onClick={() =>
          setMessageData((preData) => ({
            id: preData.id + 1,
            message: messageInput,
          }))
        }
      >
        å‘é€æ¶ˆæ¯
      </button>
      <MessageText message={messageData.message} />
    </div>
  );
}

function MessageText(props) {
  console.log("render in child");
  return <div>æœ€æ–°æ¶ˆæ¯ï¼š{props.message}</div>;
}
```

è¿ç»­ç‚¹å‡»å‡ æ¬¡æŒ‰é’®ï¼š

![](../images/react-messager.png)

çˆ¶ç»„ä»¶ `Messager` ç”±äºçŠ¶æ€æ›´æ–°ï¼Œéœ€è¦é‡æ–°æ‰§è¡Œ render å‡½æ•°æ¥æ›´æ–°ç»„ä»¶ï¼Œè¿™ä¸ªæ˜¯ç¬¦åˆé¢„æœŸçš„ã€‚å­ç»„ä»¶ `MessageText` ä¸­ï¼Œç¬¬ä¸€æ¬¡æ›´æ–°ï¼Œç”±äº `message` å±æ€§æ”¹å˜ï¼Œä¹Ÿéœ€è¦æ›´æ–°ï¼Œè¿™ä¸ªä¹Ÿå®¹æ˜“ç†è§£ã€‚

é—®é¢˜åœ¨åé¢å‡ æ¬¡æ›´æ–°ï¼š

- å­ç»„ä»¶çš„ props æ²¡æœ‰å˜åŒ–ï¼Œä¸ºä»€ä¹ˆæ‰§è¡Œäº† render å‡½æ•°ï¼Ÿ
- render å‡½æ•°æ‰§è¡Œäº†ï¼Œæ˜¯ä¸æ˜¯æ„å‘³ç€ DOM ä¹Ÿæ›´æ–°äº†ï¼Œåªæ˜¯æˆ‘ä»¬çœ‹ä¸å‡ºå˜åŒ–ï¼Ÿ
- ç»„ä»¶åœ¨ props æ²¡æœ‰å˜åŒ–æ—¶ï¼Œç»˜åˆ¶çš„è§†å›¾éƒ½æ˜¯ä¸å˜çš„ï¼Œèƒ½ä¸èƒ½è·³è¿‡ render å‡½æ•°çš„æ‰§è¡Œï¼Ÿ

è®©æˆ‘ä¸€ä¸ªä¸€ä¸ªæ¥å›ç­”ã€‚

**Qï¼šä¸ºä»€ä¹ˆéœ€è¦æ‰§è¡Œ render å‡½æ•°ï¼Ÿ**

Aï¼šä½ çš„ç»„ä»¶å¯èƒ½ä½¿ç”¨äº†ä»»ä½•å˜é‡ï¼ŒåŒ…æ‹¬å…¨å±€å˜é‡ã€ç¯å¢ƒå˜é‡ç­‰ï¼ŒReact æ²¡æœ‰èƒ½åŠ›åšåˆ°ç›‘å¬è¿™äº›å˜é‡ï¼Œè¿™äº›å˜é‡çš„å˜åŒ–æ˜¯ React æ— æ³•æ„ŸçŸ¥çš„ã€‚ä¸ºäº†ä¿è¯æ¸²æŸ“çš„è§†å›¾ä¸æ•°æ®æ˜¯ä¸€è‡´çš„ï¼ŒReact åªèƒ½ç‰ºç‰²æ€§èƒ½ï¼Œåœ¨æ¯æ¬¡æ›´æ–°çš„æ—¶å€™ï¼Œéƒ½å»æ‰§è¡Œ render å‡½æ•°ï¼Œè·å–æœ€æ–°çš„ render è¾“å‡ºã€‚

**Q: æ‰§è¡Œäº† render å‡½æ•°å°±ä¸€å®šä¼šæ›´æ–° DOM å—ï¼Ÿ**

Aï¼šä¸ä¸€å®šã€‚render å‡½æ•°çš„è¾“å‡ºç»“æœæ˜¯ React è™šæ‹Ÿ DOMï¼Œæ‰§è¡Œäº† render å‡½æ•°ä¼šæ›´æ–°è™šæ‹Ÿ DOMï¼Œä½† React è¶³å¤Ÿèªæ˜ï¼Œèƒ½å¤Ÿæ¯”å¯¹å‡ºæµè§ˆå™¨ DOM éœ€è¦æ›´æ–°çš„åœ°æ–¹ï¼Œè®©æµè§ˆå™¨åªè¿›è¡Œå¿…è¦çš„é‡ç»˜ã€‚è¿™ä¹Ÿæ˜¯ React èƒ½å¤Ÿä¿è¯æ€§èƒ½çš„é‡è¦æ‰‹æ®µã€‚

**Qï¼šèƒ½é¿å…ä¸å¿…è¦çš„ render æ‰§è¡Œå—ï¼Ÿ**

Aï¼šå¯ä»¥ã€‚å¦‚æœæ˜¯ class ç»„ä»¶(CC)ï¼Œä½ å¯ä»¥é‡å†™ `shouldComponentUpdate()` æ–¹æ³•æˆ–ç»§æ‰¿ `React.PureComponent`ã€‚å¦‚æœæ˜¯å‡½æ•°ç»„ä»¶(FC)ï¼Œä½ å¯ä»¥ä½¿ç”¨ `React.memo()` ã€‚è¿™æ ·èƒ½å¤Ÿé¿å…ä¸å¿…è¦çš„ render æ‰§è¡Œï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šæå‡é¡µé¢çš„æ€§èƒ½ï¼Œå°¤å…¶æ˜¯å½“ render å‡½æ•°å†…æœ‰å¤æ‚è®¡ç®—æ—¶ã€‚è¿™ä¹Ÿæ­£æ˜¯çº¯ç»„ä»¶æƒ³è¦è§£å†³çš„é—®é¢˜ã€‚

## æ€ä¹ˆä½¿ç”¨çº¯ç»„ä»¶

### CC: `shouldComponentUpdate()` å’Œ `React.PureComponent`

> ğŸ’¡ è¿™ä¸€å°èŠ‚çš„å†…å®¹åŸºäº class ç»„ä»¶ï¼ŒFC ä¸é€‚ç”¨ã€‚

React ç»„ä»¶æ›´æ–°å‰ï¼Œä¼šè°ƒç”¨ `shouldComponentUpdate(nextProps,nextState)`ï¼Œå½“è¿”å› `true` æ—¶ï¼Œç»„ä»¶å°±ä¼š re-renderã€‚æ‰€ä»¥ï¼Œä½ å¯ä»¥é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œå½“ä¸å¸Œæœ›ç»„ä»¶æ›´æ–°æ—¶ï¼Œè¿”å› `false`ã€‚

é‡å†™ä¸Šé¢çš„ `MessageText` ç»„ä»¶ï¼š

```jsx
class MessageText extends React.Component {
  shouldComponentUpdate(nextProps) {
    if (nextProps.message === this.props.message) {
      return false;
    }
    return true;
  }

  render() {
    console.log("render in child with message=" + this.props.message);
    return <div>æœ€æ–°æ¶ˆæ¯ï¼š{this.props.message}</div>;
  }
}
```

è¿™æ ·ï¼Œ`render` å‡½æ•°åªä¼šåœ¨ `props.message` å˜åŒ–çš„æ—¶å€™æ‰ä¼šè¢«è°ƒç”¨ã€‚å½“ç„¶ï¼Œä½ å¯ä»¥è‡ªå·±å†³å®šå“ªäº›æ¡ä»¶ä¸‹è·³è¿‡ renderã€‚

> ğŸ’¡ shouldComponentUpdate è¿”å› false æ—¶å¹¶**ä¸èƒ½ä¿è¯**è·³è¿‡ renderã€‚React åç»­å¯èƒ½ä¼šå¢åŠ è‡ªå·±çš„åˆ¤æ–­ï¼ŒåªæŠŠè¿™ä¸ªè¿”å›ç»“æœä½œä¸ºä¸€ç§æç¤ºã€‚æ‰€ä»¥è¿™ä¸ªæ–¹æ³•åº”è¯¥åªèƒ½è¢«ç”¨äºæ€§èƒ½ä¼˜åŒ–ï¼Œä¸èƒ½ä½œä¸ºé€»è¾‘ä¾èµ–ã€‚

å¤§éƒ¨åˆ†æ—¶å€™ï¼Œæˆ‘ä»¬æœŸæœ›åœ¨ props å’Œ state ä¸å˜çš„æ—¶å€™ï¼Œè·³è¿‡ renderï¼Œå› ä¸ºè¿™ç»å¸¸å¯¼è‡´ä¸å¿…è¦çš„æ›´æ–°ã€‚ä¸Šé¢çš„ä¾‹å­åªæœ‰ä¸€ä¸ªå±æ€§ï¼Œæœ‰ç‚¹è¿‡äºç®€å•äº†ï¼Œç»„ä»¶å¯èƒ½ä¼šå¤šä¸ª props å’Œ stateï¼Œéœ€è¦åœ¨ `()` ä¸­ç©·ä¸¾æ¯”è¾ƒã€‚å› ä¸ºè¿™ç§æ¨¡å¼å¤ªè¿‡å¸¸è§ï¼ŒReact æä¾›äº† `React.PureComponent` ç±»ï¼Œä½ å¯ä»¥ç»§æ‰¿è¿™ä¸ªç±»ï¼Œæ¥å®ç°çº¯ç»„ä»¶çš„æ•ˆæœï¼Œå³å½“ props å’Œ state ä¸å˜ï¼ˆæµ…æ¯”è¾ƒï¼‰æ—¶ï¼Œè·³è¿‡ renderã€‚

```jsx
class MessageText extends React.PureComponent {
  render() {
    console.log("render in child with message=" + this.props.message);
    return <div>æœ€æ–°æ¶ˆæ¯ï¼š{this.props.message}</div>;
  }
}
```

### FC: `React.memo()`

å…ˆå›ç­”ä¸€ä¸ªæ™®éç–‘æƒ‘çš„é—®é¢˜ã€‚

Qï¼šFC æ˜¯çº¯ç»„ä»¶å—ï¼Ÿæˆ–è€…æ— çŠ¶æ€çš„ FC æ˜¯çº¯ç»„ä»¶å—ï¼Ÿ
Aï¼šå¹¶ä¸æ˜¯ã€‚ä»æœ€ä¸Šé¢çš„ä¾‹å­å°±å¯ä»¥çœ‹å‡ºæ¥ã€‚æ— çŠ¶æ€ FC ä¸çº¯ç»„ä»¶æ˜¯ç‹¬ç«‹çš„æ¦‚å¿µï¼ŒçŠ¶æ€å¹¶ä¸æ˜¯å½±å“çº¯ç»„ä»¶çš„å› ç´ ï¼Œå…³é”®åœ¨äºç»„ä»¶å‡½æ•°é™¤äº† state å’Œ props æœ‰æ²¡æœ‰å¤–éƒ¨ä¾èµ–ï¼Œå¯¹å¤–éƒ¨æœ‰æ²¡æœ‰å½±å“ã€‚

Qï¼šæ—¢ç„¶å¦‚æ­¤ï¼Œæ€ä¹ˆæŠŠ FC æ”¹é€ æˆçº¯ç»„ä»¶ï¼Ÿ
A:å¾ˆç®€å•ï¼Œç”¨ class é‡å†™ç»„ä»¶å¹¶ç»§æ‰¿ `React.PureComponent` å°±å¯ä»¥äº†ã€‚

è¯´ç¬‘äº†ï¼Œè¿™å¹´å¤´ï¼Œè°å†™ React è¿˜ç”¨ class å•Šã€‚

ç„¶è€Œï¼Œå¾ˆé—æ†¾ï¼Œhooks æ— æ³•è¦†ç›– `shouldComponentUpdate()` çš„ä½¿ç”¨åœºæ™¯ï¼ŒFC æ²¡æœ‰ç­‰æ•ˆäº `React.PureComponent` çš„å†™æ³•ã€‚

ä¸è¿‡ï¼Œå€’æ˜¯å¯ä»¥ä½¿ç”¨ `React.memo()` å®ç°ä¸€ä¸ªåŠåŠå­çš„çº¯ç»„ä»¶ã€‚

```js
const memorizedFC=React.memo(FC,arePropsEqual(preProps,nextProps)=>{
    // è¿”å›trueï¼Œè·³è¿‡render
    // è¿”å›falseï¼Œæ‰§è¡Œrender
})
```

`React.memo()` æŠŠä¸Šæ¬¡è°ƒç”¨çš„ç»“æœä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œä¸‹æ¬¡è°ƒç”¨æ—¶ï¼Œå¦‚æœ `arePropsEqual()` è¿”å› `true`ï¼Œé‚£å°±ç›´æ¥ä½¿ç”¨ä¸Šæ¬¡çš„ç»“æœï¼Œä¸éœ€è¦æ‰§è¡Œ FCã€‚`arePropsEqual` å‚æ•°å¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨æµ…æ¯”è¾ƒã€‚

åˆ©ç”¨ `React.memo()`, æŠŠ `MessageText` æ”¹é€ æˆçº¯ç»„ä»¶ `PureMessageText`ï¼š

```jsx
function MessageText(props) {
  console.log("render in child with message=" + props.message);
  return <div>æœ€æ–°æ¶ˆæ¯ï¼š{props.message}</div>;
}

const PureMessageText = React.memo(MessageText);
```

æ³¨æ„ `React.memo()` å¹¶ä¸ç­‰æ•ˆäº `React.PureComponent`ï¼Œå‰è€…åªèƒ½æ¯”è¾ƒ propsï¼Œå¯¹äºçŠ¶æ€å¯¼è‡´çš„æ›´æ–°ï¼ŒFC ä¾ç„¶ä¼šæ‰§è¡Œã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¯´æ˜¯â€œåŠåŠå­çº¯ç»„ä»¶â€ã€‚

å¦‚æœ FC æ— çŠ¶æ€ï¼Œé‚£ `React.memo()` å°±å¯ä»¥ç­‰æ•ˆäº `React.PureComponent` äº†ã€‚æ—¢ç„¶å¦‚æ­¤ï¼Œå¯¹æœ‰çŠ¶æ€ FCï¼Œå¯ä»¥åˆ©ç”¨çŠ¶æ€ä¸Šç§»æŠŠ state è½¬ä¸º propsï¼Œå†åº”ç”¨ `React.memo()`, å®ç°çº¯ç»„ä»¶çš„æ•ˆæœã€‚

æ‰€ä»¥ï¼Œç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ`React.memo()` å·²ç»è¶³å¤Ÿäº†ã€‚

## ä½ å¹¶ä¸éœ€è¦çº¯ç»„ä»¶

äº†è§£çº¯ç»„ä»¶çš„æ¦‚å¿µï¼Œä»¥åŠå®ƒå¯¹ React åº”ç”¨æ€§èƒ½çš„å½±å“ï¼Œå¯¹ä¸€ä¸ªå¼€å‘è€…æœ‰å¾ˆå¤§å¸®åŠ©ï¼Œä½†è¿™å¹¶ä¸æ„å‘³ç€ä½ éœ€è¦ç»å¸¸ä½¿ç”¨å®ƒã€‚

React æä¾›äº†è‰¯å¥½çš„æ€§èƒ½ä¿è¯ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œä½ çš„åº”ç”¨ä¸ä¼šæœ‰æ€§èƒ½ä¸Šçš„é—®é¢˜ï¼Œä½¿ç”¨çº¯ç»„ä»¶åè€Œå¢åŠ ç†è§£æˆæœ¬ã€‚

å³ä½¿å‡ºç°äº†æ€§èƒ½é—®é¢˜ï¼Œä¸€äº›é€šç”¨çš„æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µå¯èƒ½æ›´æœ‰æ•ˆæœã€‚åªæœ‰å½“æ€§èƒ½ç“¶é¢ˆå‡ºç°åœ¨ç‰¹å®šç»„ä»¶çš„ renderï¼Œå¹¶ä¸”è¿™ä¸ªç»„ä»¶å¯ä»¥è¢«æ”¹é€ æˆçº¯ç»„ä»¶æ—¶ï¼Œè¿™ä¸ªæªæ–½æ‰ä¼šæœ‰æ•ˆæœã€‚
